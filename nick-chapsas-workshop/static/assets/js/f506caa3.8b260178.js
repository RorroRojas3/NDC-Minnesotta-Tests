"use strict";(self.webpackChunktesting_workshop=self.webpackChunktesting_workshop||[]).push([[7226],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(n),h=i,m=d["".concat(s,".").concat(h)]||d[h]||u[h]||r;return n?a.createElement(m,o(o({ref:t},c),{},{components:n})):a.createElement(m,o({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6450:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const r={description:"Having to run the API manually is painful. Let's fix it"},o="Running the API smarter",l={unversionedId:"integration-testing/api/using-waf",id:"integration-testing/api/using-waf",title:"Running the API smarter",description:"Having to run the API manually is painful. Let's fix it",source:"@site/docs/integration-testing/api/using-waf.md",sourceDirName:"integration-testing/api",slug:"/integration-testing/api/using-waf",permalink:"/integration-testing/api/using-waf",draft:!1,tags:[],version:"current",frontMatter:{description:"Having to run the API manually is painful. Let's fix it"},sidebar:"docs",previous:{title:"Dealing with leftover data",permalink:"/integration-testing/api/leftover-data"},next:{title:"Writing the rest of the tests",permalink:"/integration-testing/api/write-the-tests"}},s={},p=[{value:"The problem",id:"the-problem",level:2},{value:"Running the API",id:"running-the-api",level:2},{value:"The WebApplicationFactory",id:"the-webapplicationfactory",level:2},{value:"Using the WebApplicationFactory",id:"using-the-webapplicationfactory",level:2}],c={toc:p};function u(e){let{components:t,...r}=e;return(0,i.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"running-the-api-smarter"},"Running the API smarter"),(0,i.kt)("h2",{id:"the-problem"},"The problem"),(0,i.kt)("p",null,"Even though the approach that we've seen until now works well enough and it does actually properly function as an integration testing approach,\nit suffers from a few problems. "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The API needs to be running at all times so the tests can target it"),(0,i.kt)("li",{parentName:"ul"},"A database needs to be running at all times so the API that is being called by the tests can target it")),(0,i.kt)("p",null,"Let's start from the first problem"),(0,i.kt)("h2",{id:"running-the-api"},"Running the API"),(0,i.kt)("p",null,"Historically, one of the biggest pains when it comes to integration testing is to actually run the API just for the tests and tear it down.\nTechnically we can still implement it for our usecase but we really don't need to. "),(0,i.kt)("p",null,"Microsoft has noticed that this was a problem that many people had for a very long time and they created the ",(0,i.kt)("inlineCode",{parentName:"p"},"WebApplicationFactory"),"."),(0,i.kt)("h2",{id:"the-webapplicationfactory"},"The WebApplicationFactory"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"WebApplicationFactory")," is a class that allows us to create a ",(0,i.kt)("inlineCode",{parentName:"p"},"TestServer")," that runs our API.\nThis API is only accessible in-memory so a regular HttpClient or a browser can't access it.\nThe only way to access it is to use an ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClient")," specifically created to call this in-memory application.\nThis make is an excellent candidate for integration testing and it is by far the best way to write them."),(0,i.kt)("p",null,"Let's see how we can use it for our own existing test."),(0,i.kt)("h2",{id:"using-the-webapplicationfactory"},"Using the WebApplicationFactory"),(0,i.kt)("p",null,"First let's shut down the running API. We don't need it anymore."),(0,i.kt)("p",null,"To use the ",(0,i.kt)("inlineCode",{parentName:"p"},"WebApplicationFactory")," we need a few project-level changes."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"In the ",(0,i.kt)("inlineCode",{parentName:"li"},"csproj")," of the test project we need to change the ",(0,i.kt)("inlineCode",{parentName:"li"},"Project Sdk")," from ",(0,i.kt)("inlineCode",{parentName:"li"},"Microsoft.NET.Sdk")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"Microsoft.NET.Sdk.Web")),(0,i.kt)("li",{parentName:"ol"},"We need to add the ",(0,i.kt)("inlineCode",{parentName:"li"},"Microsoft.AspNetCore.Mvc.Testing")," Nuget package")),(0,i.kt)("p",null,"New we can simply add the ",(0,i.kt)("inlineCode",{parentName:"p"},"WebApplicationFactory")," as a field in our test class:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"private readonly WebApplicationFactory<> _waf = new();\n")),(0,i.kt)("p",null,"As you might have noticed the ",(0,i.kt)("inlineCode",{parentName:"p"},"WebApplicationFactory")," need a generic parameter. This parameter is an assembly scanning marker.\nIt can be any type inside the project we want to run. We could expose the ",(0,i.kt)("inlineCode",{parentName:"p"},"Program.cs")," as an internal to the integration tests project but the preferred approach is to create an assembly marker.\nAn assembly marker is a simple empty type (usually an interface) that can be used by multiple things for assembly scanning."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"public interface IApiMarker {}\n")),(0,i.kt)("p",null,"Now our WebApplicationFactory field can use this marker and it looks like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"private readonly WebApplicationFactory<IApiMarker> _waf = new();\n")),(0,i.kt)("p",null,"Now we can replace the existing ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClient")," initialization code to use an ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClient")," generated from the ",(0,i.kt)("inlineCode",{parentName:"p"},"CreateClient")," call of the WebApplicationFactory."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'private readonly WebApplicationFactory<IApiMarker> _waf = new();\n\nprivate readonly HttpClient _client;\nprivate readonly List<Guid> _idsToDelete = new();\n\npublic CustomerControllerTests()\n{\n    _client = _waf.CreateClient(new WebApplicationFactoryClientOptions\n    {\n        BaseAddress = new Uri("https://localhost:5001")\n    });\n}\n')),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"Note: We can even pass custom ",(0,i.kt)("inlineCode",{parentName:"em"},"WebApplicationFactoryClientOptions")," for our client. This is optional but we are using it just to see how it would look like.")),(0,i.kt)("p",null,"Now we can run the exact same test code and our test will pass:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(4899).Z,width:"904",height:"294"})),(0,i.kt)("p",null,"This is still a completely valid integration test which calls the database and cleans the data up in the end."))}u.isMDXComponent=!0},4899:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/waf-test-28405a403bfd4e94674b1fe765d14fd1.png"}}]);