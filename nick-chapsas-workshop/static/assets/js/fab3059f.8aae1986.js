"use strict";(self.webpackChunktesting_workshop=self.webpackChunktesting_workshop||[]).push([[2842],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),h=p(n),d=a,m=h["".concat(l,".").concat(d)]||h[d]||u[d]||i;return n?r.createElement(m,s(s({ref:t},c),{},{components:n})):r.createElement(m,s({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,s=new Array(i);s[0]=h;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:a,s[1]=o;for(var p=2;p<i;p++)s[p]=n[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9347:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const i={description:"Let's write our first integration test for the API"},s="Our first integration test",o={unversionedId:"integration-testing/api/first-integration-test",id:"integration-testing/api/first-integration-test",title:"Our first integration test",description:"Let's write our first integration test for the API",source:"@site/docs/integration-testing/api/first-integration-test.md",sourceDirName:"integration-testing/api",slug:"/integration-testing/api/first-integration-test",permalink:"/integration-testing/api/first-integration-test",draft:!1,tags:[],version:"current",frontMatter:{description:"Let's write our first integration test for the API"},sidebar:"docs",previous:{title:"The Customers API",permalink:"/integration-testing/api/the-api"},next:{title:"Dealing with leftover data",permalink:"/integration-testing/api/leftover-data"}},l={},p=[{value:"Project structure",id:"project-structure",level:2},{value:"The test",id:"the-test",level:2},{value:"Arrange",id:"arrange",level:3},{value:"Act",id:"act",level:3},{value:"Assert",id:"assert",level:3}],c={toc:p};function u(e){let{components:t,...i}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"our-first-integration-test"},"Our first integration test"),(0,a.kt)("p",null,"Let's begin by writing our first integration test.\nAs a prerequisite, keep in mind that both the Database and the API are currently running on our workstation."),(0,a.kt)("p",null,"As a refresher, here are the command that I will be running"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-commandline"},"docker compose up\ndotnet run -c Release\n")),(0,a.kt)("h2",{id:"project-structure"},"Project structure"),(0,a.kt)("p",null,"The project structure that we followed until now for unit testing will continue to be followed for integration testing.\nThis includes the ",(0,a.kt)("inlineCode",{parentName:"p"},"src")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"tests")," folders, the naming convention of the test project,\nthe naming convention and folder structure of test classes and also the naming of tests."),(0,a.kt)("h2",{id:"the-test"},"The test"),(0,a.kt)("p",null,"Our first test will be a very simple one. We are going to test that when we creating a user with valid details, then the customer is created.\nThe name for this test will be ",(0,a.kt)("inlineCode",{parentName:"p"},"Create_ShouldCreateCustomer_WhenDetailsAreValid"),"."),(0,a.kt)("p",null,"The structure of the test will be the exact same as in the unit test to start with."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp",metastring:'title="CustomerControllerTests.cs"',title:'"CustomerControllerTests.cs"'},"[Fact]\npublic async Task Create_ShouldCreateCustomer_WhenDetailsAreValid()\n{\n    // Arrange\n\n    // Act\n\n    // Assert\n        \n}\n")),(0,a.kt)("h3",{id:"arrange"},"Arrange"),(0,a.kt)("p",null,"Previously we've used the arrange section to mock things out and created all the data needed. This is still the case in integration testing but there is no need to mock anything.\nSince the API is already running we will just need to create our ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpClient")," and initialize our request and expected response object."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'// Arrange\nvar client = new HttpClient\n{\n    BaseAddress = new Uri("https://localhost:5001")\n};\n\nvar request = new CustomerRequest\n{\n    Email = "nick@chapsas.com",\n    FullName = "Nick Chapsas",\n    DateOfBirth = new DateTime(1993, 01, 01),\n    GitHubUsername = "nickchapsas"\n};\n')),(0,a.kt)("p",null,"These are the main two components we will be using for the test. The ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpClient")," will be used to call the running API.\nThe ",(0,a.kt)("inlineCode",{parentName:"p"},"CustomerRequest")," class is part of our API contracts. We even have access to the ",(0,a.kt)("inlineCode",{parentName:"p"},"CustomerResponse")," API contract to assert against.\nIt is not uncommon for projects to export their API contracts to a dedicated project.\nIn this case it doesn't matter because we will need a reference to the API project directly later."),(0,a.kt)("h3",{id:"act"},"Act"),(0,a.kt)("p",null,"The action we will perform is simple. We will simply call the API through the HttpClient.\nWe ",(0,a.kt)("em",{parentName:"p"},"could")," use the ",(0,a.kt)("inlineCode",{parentName:"p"},"PostAsync")," method of the ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpClient")," but thankfully we have a helper method from ",(0,a.kt)("inlineCode",{parentName:"p"},"Microsoft")," that will make sending the JSON object itself as the request body very simple."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'// Act\nvar response = await client.PostAsJsonAsync("customers", request);\n')),(0,a.kt)("h3",{id:"assert"},"Assert"),(0,a.kt)("p",null,"In integration tests, we tend to assert against more things than unit testing. This is mainly due to the fact that more things are being tested."),(0,a.kt)("p",null,"In this specific example we need to validate the following:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"That the response status code is ",(0,a.kt)("inlineCode",{parentName:"li"},"201")," ",(0,a.kt)("inlineCode",{parentName:"li"},"Created")),(0,a.kt)("li",{parentName:"ul"},"That the response body matches what we expect it to be"),(0,a.kt)("li",{parentName:"ul"},"That the ",(0,a.kt)("inlineCode",{parentName:"li"},"Location")," header matches the ",(0,a.kt)("inlineCode",{parentName:"li"},"GET")," location of the customer resource")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"StatusCode")," and the ",(0,a.kt)("inlineCode",{parentName:"p"},"Headers")," are both parameters of the ",(0,a.kt)("inlineCode",{parentName:"p"},"HttpResponseMessage")," object that the ",(0,a.kt)("inlineCode",{parentName:"p"},"PostAsJsonAsync")," method will return."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"CustomerResponse")," can be retrieved from the ",(0,a.kt)("inlineCode",{parentName:"p"},"Content")," object of the response. There are multiple method provided by .NET to read the body.\nSince we know that the result should be a JSON object we will use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ReadFromJsonAsync<T>")," method."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'// Assert\nresponse.StatusCode.Should().Be(HttpStatusCode.Created);\n\nvar customerResponse = await response.Content.ReadFromJsonAsync<CustomerResponse>();\ncustomerResponse.Should().BeEquivalentTo(request);\n\nresponse.Headers.Location.Should().Be($"https://localhost:5001/customers/{customerResponse!.Id}");\n')),(0,a.kt)("p",null,"And at it's core, that's it! However there is a ",(0,a.kt)("em",{parentName:"p"},"small")," problem. "),(0,a.kt)("p",null,"Taking a look at the database reveals that problem:"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(116).Z,width:"1628",height:"156"})),(0,a.kt)("p",null,"The items created as part of our integration tests remain in the database.\nDepending on which database we are using and how we are dealing with it, this can be a big problem."),(0,a.kt)("p",null,"There are multiple ways to deal with this problem in integration testing but let's start with the simplest one."))}u.isMDXComponent=!0},116:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/db-result-14555d1b003af53c6c263fb6e0359782.png"}}]);